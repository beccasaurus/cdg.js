<!DOCTYPE>
<html>
  <head>
    <title>CD+G Rendering Prototype</title>
  </head>
  <body>
    <input type="file" id="cdg-file" /><br />
    <canvas id="cdg-canvas" width="294" height="204" style="border: 1px solid black;"></canvas>
    <pre>
      [_] renderNextTile() - go through and find the next tile and puts its pixel indices in the right places
          [_] put indices into array on Normal tile
          [_] put XOR into array on XOR Tile
      [_] Update to also load color table
      [_] DRAW
      [_] track second array of index:RGB color
      [_] renderNextTiles(N) - render the next X tiles
      ...
      
      For now IGNORE BORDER and only render displayable area
    </pre>
    <script>
      // helpers
      function arrayMatrix(rows, columns) {
        var matrix = [];
        for (var i = 0; i < rows; i++) {
          var row = [];
          for (var j = 0; j < columns; j++) {
            row.push(0);
          }
          matrix.push(row);
        }
        return matrix;
      }

      // globals
      var display_width = 294;
      var display_height = 204;
      var tiles_per_row = 6;
      var tiles_per_column = 4;
      var tile_width = display_width / tiles_per_row;
      var tile_height = display_height / tiles_per_column;
      var pixelColorIndices = arrayMatrix(display_width, display_height);
      var pixelColor = arrayMatrix(display_width, display_height);
      var arrayBuffer = null;
      var packetsRead = 0;

      var readFile = function() {
        var reader = new FileReader();
        reader.onload = function(e) {
          console.log("onload");
          window.arrayBuffer = reader.result;
          window.packetsRead = 0;
          console.log("Read file into ArrayBuffer");
          console.log(window.arrayBuffer);
        };
        var selectedFile = document.getElementById("cdg-file").files[0];
        reader.readAsArrayBuffer(selectedFile);
      }

      // render tile functions
      var renderNextTile = function() {
        var packet = getNextPacket();
        while (packet.instruction != 6) { // only get Normal Tiles for now
          packet = getNextPacket();
        }
        console.log("Next tile packet:");
        console.log(packet);
      };

      // CD+G packet parsing
      var getNextPacket = function() {
        var packetBytes = new Uint8Array(arrayBuffer, window.packetsRead * 24, 24)
        window.packetsRead++;
        return {
          command: packetBytes[0] & 0x3F,
          instruction: packetBytes[1] & 0x3F,
          data: packetBytes.subarray(4, 16)
        };
      }
    </script>
  </body>
</html>
